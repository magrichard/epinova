---
title: "Premiers essais sur le jeu de données"
author: "Fabien KON-SUN-TACK"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
---

```{r, echo=FALSE, eval=TRUE}
knitr::opts_chunk$set(collapse=TRUE, comment = "#>", fig.width=9, fig.height=6, eval=TRUE, echo=FALSE, results="hide")
```

```{r loading_data}
library(tibble)
library(dplyr)
library(ggplot2)
if (!exists("mreadRDS")) {mreadRDS = memoise::memoise(readRDS)}
# s = mreadRDS("../../data/study_hadaca_epic.rds")
d = s$data
e = s$exp_grp
e$cond = substr(s$exp_grp$cond, 1, 4)
```

# Design 

```{r exp_grp, echo=TRUE, results="verbatim"}
table(e$cond)
print("4 conditions, 8 réplicats par condition")
```

## Data
```{r echo=TRUE, results="verbatim", label = "Data Description"}
idx_A = colnames(d)[01:08]
idx_B = colnames(d)[09:16]
idx_C = colnames(d)[17:24]
idx_D = colnames(d)[25:32]
print(head(d[,idx_A]))
print(head(d[,idx_B]))
print(head(d[,idx_C]))
print(head(d[,idx_D]))
```

## Graphs
```{r plot_data, echo=TRUE, fig.height=9}
layout(matrix(1:4, 2), respect=TRUE)
hist(d[,idx_A], main="Condition A: HCT116 double KO DNMT1-DNMT3")
hist(d[,idx_B], main="Condition B: HCT116 simple KO DNMT1")
hist(d[,idx_C], main="Condition C: HCT116 WT serum")
hist(d[,idx_D], main="Condition D: HCT116 WT serum deprivation 24h")
```

# Univariate Analysis

## Student tests

```{r ewas_mean, echo=TRUE, eval=TRUE, results="verbatim"}
apply_func = apply
apply_func = epimedtools::monitored_apply
# if (!file.exists("ewas_mean.rds")) {
  ewas_mean <- apply_func(d[1:1000,] , 1, function(l) {  
    # print(l)
    # l = d[1,]

    data = data.frame(meth=l, cond=e[names(l),]$cond)
    m_AC = lm(meth~cond, data[c(idx_A, idx_C),])
    m_BC = lm(meth~cond, data[c(idx_B, idx_C),])
    m_DC = lm(meth~cond, data[c(idx_D, idx_C),])
  
    pval_AC = anova(m_AC)[1,5]
    pval_BC = anova(m_BC)[1,5]
    pval_DC = anova(m_DC)[1,5]
  
    beta_AC = m_AC$coef[[2]]
    beta_BC = m_BC$coef[[2]]
    beta_DC = m_DC$coef[[2]]
  
    ret = c(
      pval_AC = pval_AC,
      pval_BC = pval_BC,
      pval_DC = pval_DC,
      beta_AC = beta_AC,
      beta_BC = beta_BC,
      beta_DC = beta_DC,
      NULL
    )
    return(ret)
    }
  )
  ewas_mean = data.frame(t(ewas_mean))
  head(ewas_mean)
#   saveRDS(ewas_mean, "ewas_mean.rds")
# }
# ewas_mean = readRDS("ewas_mean.rds")

```


## Fisher tests (variance)
```{r ewas_var, echo=TRUE, eval=TRUE, results="verbatim"}
# if (!file.exists("ewas_var.rds")) {
  ewas_var <- apply_func(d[1:1000,] , 1, function(l) {  
    # print(l)
    # l = d[1,]
  
    vtest_AC = var.test(l[idx_A],l[idx_C])
    vtest_BC = var.test(l[idx_B],l[idx_C])
    vtest_DC = var.test(l[idx_D],l[idx_C])

    pval_AC = vtest_AC$p.value 
    pval_BC = vtest_BC$p.value 
    pval_DC = vtest_DC$p.value 
    beta_AC = vtest_AC$estimate[[1]]
    beta_BC = vtest_BC$estimate[[1]]
    beta_DC = vtest_DC$estimate[[1]]

    ret = c(
      pval_AC = pval_AC,
      pval_BC = pval_BC,
      pval_DC = pval_DC,
      beta_AC = beta_AC,
      beta_BC = beta_BC,
      beta_DC = beta_DC,
      NULL
    )
    return(ret)
    }
  )
  ewas_var = data.frame(t(ewas_var))
  head(ewas_var)
#   saveRDS(ewas_var, "ewas_var.rds")
# }
# ewas_var = readRDS("ewas_var.rds")
```


```{r echo=TRUE, results="verbatim"}
head(ewas_mean)
head(ewas_var)
```

# FDR BH

```{r fdr_bh, echo=TRUE, eval=TRUE, results="verbatim"}
ewas_mean$padj_AC = p.adjust(ewas_mean$pval_AC, method="BH")
ewas_mean$padj_BC = p.adjust(ewas_mean$pval_BC, method="BH")
ewas_mean$padj_DC = p.adjust(ewas_mean$pval_DC, method="BH")
ewas_var$padj_AC = p.adjust(ewas_var$pval_AC, method="BH")
ewas_var$padj_BC = p.adjust(ewas_var$pval_BC, method="BH")
ewas_var$padj_DC = p.adjust(ewas_var$pval_DC, method="BH")
```

```{r exo_fdr}
plot(ewas_mean$padj_AC, ewas_mean$pval_AC)
plot(-log10(ewas_mean$padj_AC), -log10(ewas_mean$pval_AC))
abline(a=0, b=1)
abline(v=-log10(0.05), col=2, lty=2)

plot(-log10(ewas_mean$padj_AC), -log10(ewas_mean$pval_AC), xlim=c(0, 2), ylim=c(0, 2), )
abline(a=0, b=1)
abline(v=-log10(0.05), col=2, lty=2)
abline(h=-log10(0.05), col=4, lty=2)

FDR = function (x, FDR=0.05) {
    x <- sort(na.omit(x))
    N = length(x)
    i = 1
    while (N * x[i]/i < FDR & i <= N) {
      i = i + 1
    }
    if (i == 1) {
      return(NA)      
    } else {
      return(x[i - 1])
    }
}

abline(h=-log10(FDR(ewas_mean$pval_AC)), col=3, lty=2)
```

# Volcano Plot
```{r echo=T,eval=T,results="hold",label="Volcano plotting data"}
layout(matrix(1:2,1), respect=TRUE)
plot(ewas_mean$beta_AC, -log10(ewas_mean$pval_AC), xlab="beta", ylab="-log10(pval)", main="cond A vs. cond C, mean")
plot(ewas_mean$beta_AC, -log10(ewas_mean$padj_AC), xlab="beta", ylab="-log10(padj)", main="cond A vs. cond C, mean")
plot(ewas_mean$beta_BC, -log10(ewas_mean$pval_BC), xlab="beta", ylab="-log10(pval)", main="cond B vs. cond C, mean")
plot(ewas_mean$beta_BC, -log10(ewas_mean$padj_BC), xlab="beta", ylab="-log10(padj)", main="cond B vs. cond C, mean")
plot(ewas_mean$beta_DC, -log10(ewas_mean$pval_DC), xlab="beta", ylab="-log10(pval)", main="cond D vs. cond C, mean")
plot(ewas_mean$beta_DC, -log10(ewas_mean$padj_DC), xlab="beta", ylab="-log10(padj)", main="cond D vs. cond C, mean")
plot( ewas_var$beta_AC, -log10( ewas_var$pval_AC), xlab="beta", ylab="-log10(pval)", main="cond A vs. cond C, _var")
plot( ewas_var$beta_AC, -log10( ewas_var$padj_AC), xlab="beta", ylab="-log10(padj)", main="cond A vs. cond C, _var")
plot( ewas_var$beta_BC, -log10( ewas_var$pval_BC), xlab="beta", ylab="-log10(pval)", main="cond B vs. cond C, _var")
plot( ewas_var$beta_BC, -log10( ewas_var$padj_BC), xlab="beta", ylab="-log10(padj)", main="cond B vs. cond C, _var")
plot( ewas_var$beta_DC, -log10( ewas_var$pval_DC), xlab="beta", ylab="-log10(pval)", main="cond D vs. cond C, _var")
plot( ewas_var$beta_DC, -log10( ewas_var$padj_DC), xlab="beta", ylab="-log10(padj)", main="cond D vs. cond C, _var")


# ```{r echo=T, eval=T, results="verbatim"}
# table <- mreadRDS("table.rds")
# stats <-table[table[,1] < 0.05 | table[,3] < 0.05 | table[,5] < 0.05, 1:6]
# negAC <- data.frame(stats[stats[,2] < 0, 2])
# (nrow(negAC)/nrow(stats)) * 100
# negBC <- data.frame(stats[stats[,4] < 0, 4])
# (nrow(negBC)/nrow(stats)) * 100
# negCD <- data.frame(stats[stats[,6] < 0, 6])
# (nrow(negCD)/nrow(stats)) * 100
# posAC <- data.frame(stats[stats[,2] > 0, 2])
# (nrow(posAC)/nrow(stats)) * 100
# posBC <- data.frame(stats[stats[,4] > 0, 4])
# (nrow(posBC)/nrow(stats)) * 100
# posCD <- data.frame(stats[stats[,6] > 0, 6])
# (nrow(posCD)/nrow(stats)) * 100
# varsAC <- table[table[,1] < 0.05 & table[,7] < 0.05,c(1,2,7,8)]
# (nrow(varsAC)/nrow(table)) * 100
# varsBC <- table[table[,3] < 0.05 & table[,9] < 0.05,c(3,4,9,10)]
# (nrow(varsBC)/nrow(table)) * 100
# varsCD <- table[table[,5] < 0.05 & table[,11] < 0.05,c(5,6,11,12)]
# (nrow(varsCD)/nrow(table)) * 100
# ```
```





# Session Information

```{r results="verbatim"}
sessionInfo()
```

